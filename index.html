<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Outages - Claro Brasil</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --claro-red: #E60012;
            --claro-dark-red: #C5000F;
            --claro-light-red: #FFEAED;
            --text-primary: #2D3748;
            --text-secondary: #4A5568;
            --bg-light: #F7FAFC;
            --border-color: #E2E8F0;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        header {
            background-color: var(--claro-red);
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem 2rem;
        }
        
        h1 {
            font-weight: 700;
            font-size: 1.75rem;
            margin: 0;
        }
        
        h2 {
            color: var(--claro-red);
            font-weight: 600;
            font-size: 1.25rem;
            border-bottom: 2px solid var(--claro-light-red);
            padding-bottom: 0.5rem;
            margin: 0 0 1rem;
        }
        
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card-large {
            grid-column: span 2;
        }
        
        .file-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }
        
        .file-input-label {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background: var(--claro-red);
            color: white;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .file-input-label:hover {
            background: var(--claro-dark-red);
            transform: translateY(-1px);
        }
        
        .file-input-label svg {
            margin-right: 0.5rem;
        }
        
        #fileInput {
            display: none;
        }
        
        .file-info {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .summary-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--claro-red);
            margin: 0.5rem 0;
            line-height: 1;
        }
        
        .summary-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .data-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            background: var(--claro-light-red);
            color: var(--claro-red);
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #EDF2F7;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.25rem;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--claro-red);
            border-radius: 3px;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 1.5rem;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: var(--claro-red);
            border-bottom-color: var(--claro-red);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .month-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .month-btn {
            padding: 0.375rem 0.75rem;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .month-btn.active {
            background: var(--claro-red);
            color: white;
            border-color: var(--claro-red);
        }
        
        @media (max-width: 768px) {
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .card-large {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Dashboard de Outages - Claro Brasil</h1>
    </header>
    <div class="container">
        <div class="file-input-container">
            <label for="fileInput" class="file-input-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Selecionar Arquivos Excel
            </label>
            <input type="file" id="fileInput" multiple accept=".xlsx,.xls">
            <div id="fileInfo" class="file-info">Nenhum arquivo selecionado</div>
        </div>

        <div class="card-grid">
            <div class="card summary-card">
                <div class="summary-label">Total de Outages</div>
                <div class="summary-value" id="totalOutages">0</div>
            </div>
            <div class="card summary-card">
                <div class="summary-label">Período Analisado</div>
                <div class="summary-value" id="analysisPeriod">-</div>
            </div>
            <div class="card summary-card">
                <div class="summary-label">Média Diária</div>
                <div class="summary-value" id="dailyAverage">0</div>
            </div>
        </div>

        <div class="card">
            <h2>Evolução Mensal</h2>
            <div class="chart-container">
                <canvas id="chartMonthly"></canvas>
            </div>
        </div>

        <div class="card card-large">
            <h2>Análise por Cluster</h2>
            <div class="tab-container">
                <div class="tab active" data-tab="total">Visão Geral</div>
                <div class="tab" data-tab="monthly">Detalhe Mensal</div>
            </div>
            
            <div class="tab-content active" id="tab-total">
                <div class="chart-container">
                    <canvas id="chartClusters"></canvas>
                </div>
            </div>
            
            <div class="tab-content" id="tab-monthly">
                <div class="month-selector" id="monthSelector"></div>
                <div class="chart-container">
                    <canvas id="chartClustersMonthly"></canvas>
                </div>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <h2>Top Analistas</h2>
                <div class="chart-container">
                    <canvas id="chartAnalistas"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h2>Distribuição por Tecnologia</h2>
                <div class="chart-container">
                    <canvas id="chartTecnologia"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Volume por Mês</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Mês</th>
                        <th>Outages</th>
                        <th style="width: 100px;">Distribuição</th>
                    </tr>
                </thead>
                <tbody id="volumeMes"></tbody>
            </table>
        </div>

        <div class="card">
            <h2>Dias de Maior e Menor Volume por Mês</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Mês</th>
                        <th>Dia com Maior Volume</th>
                        <th>Dia com Menor Volume</th>
                    </tr>
                </thead>
                <tbody id="volumeDias"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Configuração global do Chart.js
        Chart.defaults.font.family = "'Roboto', sans-serif";
        Chart.defaults.color = '#4A5568';
        Chart.defaults.borderColor = '#E2E8F0';
        
        const analistasFoco = {
            'N0238475': 'MARLEY MARQUES RIBEIRO',
            'N5923221': 'KELLY PINHEIRO LIRA',
            'F160641': 'JENNIFER MARIA ANDRADE SANTOS',
            'N5772086': 'THIAGO PEREIRA DA SILVA',
            'N0239871': 'LEONARDO FERREIRA LIMA DE ALMEIDA',
            'N5577565': 'MARISTELLA MARCIA DOS SANTOS',
            'N5737414': 'SANDRO DA SILVA CARVALHO',
            'N5972428': 'CRISTIANE HERMOGENES DA SILVA',
            'N6173055': 'JEFFERSON LUIS GONÇALVES COITINHO',
            'N5932090': 'EVILÁZIO ANDRÉ DE MAGALHÃES GOMES PEREIRA',
            'N0255801': 'ELBERTON ANICETO HENRIQUE',
            'N4014011': 'ALAN MARINHO DIAS'
        };

        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        // Variáveis globais para armazenar dados processados
        let processedData = {
            volumeMes: {},
            volumeAnalista: {},
            volumeCluster: {},
            volumeTecnologia: {},
            diasPorMes: {},
            outagesPorDia: {},
            outagesPorClusterMes: {},
            firstDate: null,
            lastDate: null,
            totalOutages: 0
        };

        document.getElementById('fileInput').addEventListener('change', handleFiles, false);

        // Configuração dos tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(`tab-${this.dataset.tab}`).classList.add('active');
                
                if (this.dataset.tab === 'monthly') {
                    updateMonthlyClusterChart();
                }
            });
        });

        function handleFiles(event) {
            const files = event.target.files;
            const fileCount = files.length;
            
            if (fileCount === 0) {
                document.getElementById('fileInfo').textContent = 'Nenhum arquivo selecionado';
                return;
            }
            
            document.getElementById('fileInfo').textContent = `${fileCount} arquivo(s) selecionado(s)`;
            
            const promises = Array.from(files).map(readExcel);
            Promise.all(promises).then(dataArrays => {
                const allData = dataArrays.flat();
                processData(allData);
            });
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    resolve(json);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function parseDate(dateStr) {
            if (typeof dateStr === 'number') {
                // Excel serial date
                const excelEpoch = new Date(1899, 11, 30);
                const excelDate = new Date(excelEpoch.getTime() + dateStr * 24 * 60 * 60 * 1000);
                return excelDate;
            } else if (typeof dateStr === 'string') {
                // dd/mm/yyyy hh:mm format
                const [datePart, timePart] = dateStr.split(' ');
                const [day, month, year] = datePart.split('/');
                const [hours, minutes] = timePart ? timePart.split(':') : ['00', '00'];
                
                return new Date(
                    parseInt(year),
                    parseInt(month) - 1,
                    parseInt(day),
                    parseInt(hours),
                    parseInt(minutes)
                );
            }
            return new Date(dateStr);
        }

        function processData(data) {
            // Reset processed data
            processedData = {
                volumeMes: {},
                volumeAnalista: {},
                volumeCluster: {},
                volumeTecnologia: {},
                diasPorMes: {},
                outagesPorDia: {},
                outagesPorClusterMes: {},
                firstDate: null,
                lastDate: null,
                totalOutages: data.length
            };

            // Update summary information
            document.getElementById('totalOutages').textContent = data.length.toLocaleString();
            
            data.forEach(row => {
                const dataHora = parseDate(row['DIA / HORA']);
                if (isNaN(dataHora.getTime())) {
                    console.error('Data inválida:', row['DIA / HORA']);
                    return;
                }
                
                const mes = dataHora.getMonth() + 1;
                const ano = dataHora.getFullYear();
                const mesAno = `${mes.toString().padStart(2, '0')}/${ano}`;
                const dia = dataHora.getDate();
                const login = (row['LOGIN'] || '').toUpperCase();
                const cluster = row['CLUSTER'] || 'Indefinido';
                const tecnologia = row['TECNOLOGIA'] || 'Indefinida';
                const dateKey = dataHora.toISOString().split('T')[0];

                // Track first and last dates
                if (!processedData.firstDate || dataHora < processedData.firstDate) {
                    processedData.firstDate = dataHora;
                }
                if (!processedData.lastDate || dataHora > processedData.lastDate) {
                    processedData.lastDate = dataHora;
                }

                // Volume por mês
                processedData.volumeMes[mesAno] = (processedData.volumeMes[mesAno] || 0) + 1;

                // Volume por analista
                processedData.volumeAnalista[login] = (processedData.volumeAnalista[login] || 0) + 1;

                // Volume por cluster
                processedData.volumeCluster[cluster] = (processedData.volumeCluster[cluster] || 0) + 1;

                // Volume por tecnologia
                processedData.volumeTecnologia[tecnologia] = (processedData.volumeTecnologia[tecnologia] || 0) + 1;

                // Volume por cluster e mês
                processedData.outagesPorClusterMes[mesAno] = processedData.outagesPorClusterMes[mesAno] || {};
                processedData.outagesPorClusterMes[mesAno][cluster] = (processedData.outagesPorClusterMes[mesAno][cluster] || 0) + 1;

                // Outages por dia
                processedData.outagesPorDia[dateKey] = (processedData.outagesPorDia[dateKey] || 0) + 1;

                // Dias por mês
                processedData.diasPorMes[mesAno] = processedData.diasPorMes[mesAno] || {};
                processedData.diasPorMes[mesAno][dia] = (processedData.diasPorMes[mesAno][dia] || 0) + 1;
            });

            // Update analysis period
            if (processedData.firstDate && processedData.lastDate) {
                const formatOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
                const startStr = processedData.firstDate.toLocaleDateString('pt-BR', formatOptions);
                const endStr = processedData.lastDate.toLocaleDateString('pt-BR', formatOptions);
                document.getElementById('analysisPeriod').textContent = `${startStr} a ${endStr}`;
                
                // Calculate daily average
                const daysDiff = Math.ceil((processedData.lastDate - processedData.firstDate) / (1000 * 60 * 60 * 24)) + 1;
                const dailyAvg = (data.length / daysDiff).toFixed(1);
                document.getElementById('dailyAverage').textContent = dailyAvg;
            }

            renderVolumeMes();
            renderVolumeDias();
            renderAnalystChart();
            renderMonthlyChart();
            renderClusterChart();
            renderTecnologiaChart();
            setupMonthSelector();
        }

        function renderVolumeMes() {
            const tbody = document.getElementById('volumeMes');
            tbody.innerHTML = '';
            
            // Get sorted months
            const sortedMonths = Object.keys(processedData.volumeMes)
                .sort((a, b) => {
                    const [mesA, anoA] = a.split('/').map(Number);
                    const [mesB, anoB] = b.split('/').map(Number);
                    return anoA - anoB || mesA - mesB;
                });
            
            // Get max value for progress bars
            const maxValue = Math.max(...Object.values(processedData.volumeMes));
            
            sortedMonths.forEach(mesAno => {
                const [mes, ano] = mesAno.split('/');
                const count = processedData.volumeMes[mesAno];
                const progressWidth = (count / maxValue) * 100;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${monthNames[parseInt(mes)-1]} ${ano}</td>
                    <td>${count.toLocaleString()}</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${progressWidth}%"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderVolumeDias() {
            const tbody = document.getElementById('volumeDias');
            tbody.innerHTML = '';
            
            // Get sorted months
            const sortedMonths = Object.keys(processedData.diasPorMes)
                .sort((a, b) => {
                    const [mesA, anoA] = a.split('/').map(Number);
                    const [mesB, anoB] = b.split('/').map(Number);
                    return anoA - anoB || mesA - mesB;
                });
            
            sortedMonths.forEach(mesAno => {
                const [mes, ano] = mesAno.split('/');
                const dias = processedData.diasPorMes[mesAno];
                const sorted = Object.entries(dias).sort((a,b) => b[1]-a[1]);
                const maior = sorted[0];
                const menor = sorted[sorted.length -1];
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${monthNames[parseInt(mes)-1]} ${ano}</td>
                    <td>Dia ${maior[0]} (${maior[1].toLocaleString()} outages)</td>
                    <td>Dia ${menor[0]} (${menor[1].toLocaleString()} outages)</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderAnalystChart() {
            const ctx = document.getElementById('chartAnalistas').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.analystChart) {
                window.analystChart.destroy();
            }

            const focusAnalistas = Object.keys(analistasFoco);
            const labels = focusAnalistas.map(login => analistasFoco[login]).concat(['OUTROS']);

            const data = focusAnalistas.map(login => processedData.volumeAnalista[login] || 0);
            const outros = Object.keys(processedData.volumeAnalista).reduce((sum, login) => {
                return focusAnalistas.includes(login) ? sum : sum + processedData.volumeAnalista[login];
            }, 0);
            data.push(outros);

            window.analystChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Outages',
                        data: data,
                        backgroundColor: '#E60012',
                        borderColor: '#C5000F',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toLocaleString()} outages`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Outages',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function renderMonthlyChart() {
            const ctx = document.getElementById('chartMonthly').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.monthlyChart) {
                window.monthlyChart.destroy();
            }

            // Prepare data sorted by month/year
            const sortedMonths = Object.keys(processedData.volumeMes)
                .sort((a, b) => {
                    const [mesA, anoA] = a.split('/').map(Number);
                    const [mesB, anoB] = b.split('/').map(Number);
                    return anoA - anoB || mesA - mesB;
                })
                .map(mesAno => ({
                    label: mesAno,
                    name: `${monthNames[parseInt(mesAno.split('/')[0])-1]} ${mesAno.split('/')[1]}`,
                    count: processedData.volumeMes[mesAno]
                }));

            window.monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => m.name),
                    datasets: [{
                        label: 'Outages',
                        data: sortedMonths.map(m => m.count),
                        backgroundColor: 'rgba(230, 0, 18, 0.1)',
                        borderColor: '#E60012',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#E60012',
                        pointBorderColor: '#fff',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toLocaleString()} outages`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Outages',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function renderClusterChart() {
            const ctx = document.getElementById('chartClusters').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.clusterChart) {
                window.clusterChart.destroy();
            }

            // Prepare data sorted by count (descending)
            const sortedClusters = Object.entries(processedData.volumeCluster)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Show top 10 clusters

            window.clusterChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedClusters.map(c => c[0]),
                    datasets: [{
                        label: 'Outages',
                        data: sortedClusters.map(c => c[1]),
                        backgroundColor: '#E60012',
                        borderColor: '#C5000F',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toLocaleString()} outages`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Outages',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function renderTecnologiaChart() {
            const ctx = document.getElementById('chartTecnologia').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.tecnologiaChart) {
                window.tecnologiaChart.destroy();
            }

            // Prepare data sorted by count (descending)
            const sortedTecnologias = Object.entries(processedData.volumeTecnologia)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8); // Show top 8 tecnologias

            // Generate distinct colors
            const backgroundColors = [
                '#E60012', '#FF6B6B', '#FF9E4F', '#FFD166',
                '#06D6A0', '#118AB2', '#073B4C', '#7209B7'
            ];

            window.tecnologiaChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedTecnologias.map(t => t[0]),
                    datasets: [{
                        label: 'Outages',
                        data: sortedTecnologias.map(t => t[1]),
                        backgroundColor: backgroundColors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 16,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    return `${context.label}: ${context.raw.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        function setupMonthSelector() {
            const monthSelector = document.getElementById('monthSelector');
            monthSelector.innerHTML = '';
            
            if (!processedData.outagesPorClusterMes) return;
            
            const months = Object.keys(processedData.outagesPorClusterMes)
                .sort((a, b) => {
                    const [mesA, anoA] = a.split('/').map(Number);
                    const [mesB, anoB] = b.split('/').map(Number);
                    return anoA - anoB || mesA - mesB;
                });
            
            months.forEach((mesAno, index) => {
                const [mes, ano] = mesAno.split('/');
                const btn = document.createElement('button');
                btn.className = `month-btn ${index === months.length - 1 ? 'active' : ''}`;
                btn.textContent = `${monthNames[parseInt(mes)-1].substring(0, 3)}/${ano}`;
                btn.dataset.mesAno = mesAno;
                
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateMonthlyClusterChart(mesAno);
                });
                
                monthSelector.appendChild(btn);
            });
            
            // Show last month by default
            if (months.length > 0) {
                updateMonthlyClusterChart(months[months.length - 1]);
            }
        }

        function updateMonthlyClusterChart(mesAno) {
            const ctx = document.getElementById('chartClustersMonthly').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.clusterMonthlyChart) {
                window.clusterMonthlyChart.destroy();
            }
            
            if (!mesAno || !processedData.outagesPorClusterMes[mesAno]) return;
            
            const clusterData = processedData.outagesPorClusterMes[mesAno];
            
            // Prepare data sorted by count (descending)
            const sortedClusters = Object.entries(clusterData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Show top 10 clusters
            
            const [mes, ano] = mesAno.split('/');
            const monthName = monthNames[parseInt(mes)-1];
            
            window.clusterMonthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedClusters.map(c => c[0]),
                    datasets: [{
                        label: 'Outages',
                        data: sortedClusters.map(c => c[1]),
                        backgroundColor: '#E60012',
                        borderColor: '#C5000F',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Outages por Cluster - ${monthName} ${ano}`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toLocaleString()} outages`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Outages',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }
    </script>
</body>
</html>
