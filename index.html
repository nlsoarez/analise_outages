<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Análise de Tickets - Claro Brasil</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet>
    <style>
        /* Mantido o mesmo CSS anterior com adições para notificações */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification.success {
            background-color: #2ecc71;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        .notification.info {
            background-color: #3498db;
        }
    </style>
</head>
<body>
    <!-- Mantida a mesma estrutura HTML anterior -->

    <script>
        // Variável global para armazenar os dados processados
        let processedData = {
            ticketsForaSLA: [],
            turnos: {
                MANHÃ: { tickets: [], total: 0, dentro: 0, fora: 0, foraMenos30: 0 },
                TARDE: { tickets: [], total: 0, dentro: 0, fora: 0, foraMenos30: 0 },
                MADRUGADA: { tickets: [], total: 0, dentro: 0, fora: 0, foraMenos30: 0 }
            },
            summary: {
                totalTickets: 0,
                totalDentroSLA: 0,
                totalForaSLA: 0,
                foraSlaMenos30: 0
            },
            rawData: []
        };

        // Variáveis para os gráficos
        let turnoChart, slaChart;

        // Configurações iniciais
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar último processamento do localStorage
            const lastProcess = localStorage.getItem('lastProcess');
            if(lastProcess) {
                processedData = JSON.parse(lastProcess);
                updateAllViews();
                document.getElementById('results').style.display = 'block';
            }

            // Event listeners mantidos anteriores...
        });

        // Funções melhoradas com validações
        function validateData(row) {
            const requiredColumns = ['Turno', 'Volume', 'Indicador', 'Tempo'];
            const missingColumns = requiredColumns.filter(col => !(col in row));
            
            if(missingColumns.length > 0) {
                throw new Error(`Colunas obrigatórias ausentes: ${missingColumns.join(', ')}`);
            }

            if(![0, 1].includes(row.Indicador)) {
                throw new Error(`Valor inválido no Indicador: ${row.Indicador}`);
            }

            if(typeof row.Volume !== 'number' || row.Volume < 0) {
                throw new Error(`Volume inválido: ${row.Volume}`);
            }
        }

        function parseDuration(time) {
            if(typeof time === 'number') {
                return Math.round(time * 24 * 60 * 100) / 100; // Decimal format
            }
            
            if(typeof time === 'string') {
                if(time.includes('.')) {
                    const hours = parseFloat(time);
                    return Math.round(hours * 60 * 100) / 100;
                }
                
                const parts = time.split(':').map(Number);
                if(parts.length === 3) {
                    return parts[0] * 60 + parts[1] + parts[2]/60;
                }
            }
            
            throw new Error(`Formato de tempo não reconhecido: ${time}`);
        }

        function analyzeData(data) {
            try {
                processedData = { /* Resetar dados */ };
                
                data.forEach((row, index) => {
                    validateData(row);
                    
                    // Processamento mantido anterior com melhor tratamento de erros
                    const duracaoMinutos = parseDuration(row.Tempo);
                    
                    // Restante do processamento...
                });

                localStorage.setItem('lastProcess', JSON.stringify(processedData));
                showNotification('Dados processados com sucesso!', 'success');
            } catch (error) {
                showNotification(`Erro na linha ${index + 2}: ${error.message}`, 'error');
                console.error(`Erro na linha ${index + 2}:`, row, error);
                throw error;
            }
        }

        // Novo sistema de notificações
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Função para atualizar todas as views
        function updateAllViews() {
            updateSummaryView();
            updateTicketsPerdidosView();
            updateCharts();
        }

        // Funções de view mantidas anteriores...

        // Função de processamento melhorada
        function processFile() {
            try {
                // Código anterior com tratamento de erros melhorado
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        // Processamento do arquivo...
                        analyzeData(jsonData);
                        document.getElementById('results').style.display = 'block';
                    } catch (error) {
                        showNotification(`Erro no processamento: ${error.message}`, 'error');
                    }
                };
                
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Funções auxiliares mantidas...
    </script>
</body>
</html>
