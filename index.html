<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Volumetria</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
    h2 { color: #343a40; }
    .charts { display: flex; flex-wrap: wrap; gap: 30px; }
    canvas { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 0 8px #ccc; }
    input[type="file"] { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #dee2e6; }
  </style>
</head>
<body>
  <h2>Dashboard de Volumetria</h2>
  <input type="file" id="fileInput" multiple accept=".xlsx" />

  <div class="charts">
    <canvas id="chartAnalistas" width="400" height="300"></canvas>
    <canvas id="chartClusters" width="400" height="300"></canvas>
    <canvas id="chartHorarios" width="400" height="300"></canvas>
    <canvas id="chartDias" width="400" height="300"></canvas>
  </div>

  <div id="tabela"></div>

  <script>
    const loginToName = {
      "n0238475": "MARLEY MARQUES RIBEIRO",
      "n5923221": "KELLY PINHEIRO LIRA",
      "f160641": "JENNIFER MARIA ANDRADE SANTOS",
      "n5772086": "THIAGO PEREIRA DA SILVA",
      "n0239871": "LEONARDO FERREIRA LIMA DE ALMEIDA",
      "n5577565": "MARISTELLA MARCIA DOS SANTOS",
      "n5737414": "SANDRO DA SILVA CARVALHO",
      "n5972428": "CRISTIANE HERMOGENES DA SILVA",
      "n6173055": "JEFFERSON LUIS GONÇALVES COITINHO",
      "n5932090": "EVILÁZIO ANDRÉ DE MAGALHÃES GOMES PEREIRA",
      "n0255801": "ELBERTON ANICETO HENRIQUE",
      "n4014011": "ALAN MARINHO DIAS",
      "n5923996": "JULIO CESAR SANTOS SOARES"
    };

    const charts = {};

    function drawChart(id, labels, data, label, type = 'bar') {
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type,
        data: {
          labels,
          datasets: [{
            label,
            data,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    document.getElementById('fileInput').addEventListener('change', async function (e) {
      const files = e.target.files;
      const volumesAnalista = {}, volumesCluster = {}, volumesHorario = {}, volumesPorDia = {};

      for (let file of files) {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });

        workbook.SheetNames.forEach(sheetName => {
          const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

          sheet.forEach(row => {
            const keys = Object.keys(row).reduce((acc, key) => {
              const norm = key.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
              if (norm.includes('login')) acc.login = key;
              else if (norm.includes('volume')) acc.volume = key;
              else if (norm.includes('cluster')) acc.cluster = key;
              else if (norm.includes('hora')) acc.hora = key;
              else if (norm.includes('data')) acc.data = key;
              return acc;
            }, {});

            const login = String(row[keys.login] || '').toLowerCase().trim();
            const volume = Number(row[keys.volume] || 0);
            const cluster = String(row[keys.cluster] || 'Indefinido').toUpperCase();
            const hora = String(row[keys.hora] || '00:00').slice(0, 2) + 'h';
            const data = String(row[keys.data] || '').split('T')[0];

            if (!login || !volume) return;

            volumesAnalista[login] = (volumesAnalista[login] || 0) + volume;
            volumesCluster[cluster] = (volumesCluster[cluster] || 0) + volume;
            volumesHorario[hora] = (volumesHorario[hora] || 0) + volume;
            volumesPorDia[data] = (volumesPorDia[data] || 0) + volume;
          });
        });
      }

      // Tabela de analistas
      let html = '<h3>Resumo por Analista</h3><table><tr><th>Login</th><th>Nome</th><th>Total</th></tr>';
      Object.entries(volumesAnalista).sort((a, b) => b[1] - a[1]).forEach(([login, total]) => {
        const nome = loginToName[login] || 'NOME DESCONHECIDO';
        html += `<tr><td>${login.toUpperCase()}</td><td>${nome}</td><td>${total}</td></tr>`;
      });
      html += '</table>';
      document.getElementById('tabela').innerHTML = html;

      drawChart('chartAnalistas',
        Object.keys(volumesAnalista).map(k => loginToName[k] || k.toUpperCase()),
        Object.values(volumesAnalista),
        'Volume por Analista');

      drawChart('chartClusters',
        Object.keys(volumesCluster),
        Object.values(volumesCluster),
        'Volume por Cluster');

      drawChart('chartHorarios',
        Object.keys(volumesHorario),
        Object.values(volumesHorario),
        'Volume por Horário');

      drawChart('chartDias',
        Object.keys(volumesPorDia),
        Object.values(volumesPorDia),
        'Volume por Dia',
        'line');
    });
  </script>
</body>
</html>
