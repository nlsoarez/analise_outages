<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Outages - Claro Brasil</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #E60012;
            color: #fff;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        h2 {
            color: #E60012;
            border-bottom: 2px solid #E60012;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .card {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        li {
            padding: 8px 0;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
        }
        .chart-container {
            margin-top: 30px;
            height: 400px;
        }
        .file-input-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 6px;
            text-align: center;
        }
        .file-input-label {
            display: inline-block;
            padding: 10px 15px;
            background: #E60012;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .file-input-label:hover {
            background: #C5000F;
        }
        #fileInput {
            display: none;
        }
        .value {
            font-weight: bold;
            color: #E60012;
        }
        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 4px;
            margin-top: 5px;
        }
        .progress-bar {
            height: 6px;
            background-color: #E60012;
            border-radius: 4px;
        }
        .summary-card {
            text-align: center;
            padding: 15px;
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #E60012;
            margin: 10px 0;
        }
        .summary-label {
            font-size: 14px;
            color: #666;
        }
        .month-name {
            text-transform: capitalize;
        }
        .cluster-card {
            grid-column: span 2;
        }
    </style>
</head>
<body>
    <header>
        <h1>Dashboard de Outages - Claro Brasil</h1>
    </header>
    <div class="container">
        <div class="file-input-container">
            <label for="fileInput" class="file-input-label">Selecionar Arquivos Excel</label>
            <input type="file" id="fileInput" multiple accept=".xlsx,.xls">
            <div id="fileInfo" style="margin-top: 10px; font-size: 14px;"></div>
        </div>

        <div class="card-grid">
            <div class="card summary-card">
                <div class="summary-label">Total de Outages</div>
                <div class="summary-value" id="totalOutages">0</div>
            </div>
            <div class="card summary-card">
                <div class="summary-label">Período Analisado</div>
                <div class="summary-value" id="analysisPeriod">-</div>
            </div>
            <div class="card summary-card">
                <div class="summary-label">Média Diária</div>
                <div class="summary-value" id="dailyAverage">0</div>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <h2>Volume Geral por Mês</h2>
                <ul id="volumeMes"></ul>
            </div>

            <div class="card">
                <h2>Volume por Analista</h2>
                <ul id="volumeAnalista"></ul>
            </div>

            <div class="card">
                <h2>Tecnologia com Maior Atuação</h2>
                <ul id="volumeTecnologia"></ul>
            </div>
        </div>

        <div class="card-grid">
            <div class="card cluster-card">
                <h2>Clusters com Maior Atuação</h2>
                <ul id="volumeCluster"></ul>
            </div>
        </div>

        <div class="card">
            <h2>Dias de Maior e Menor Volume por Mês</h2>
            <ul id="volumeDias"></ul>
        </div>

        <div class="card">
            <h2>Evolução Mensal</h2>
            <div class="chart-container">
                <canvas id="chartMonthly"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Distribuição por Analista</h2>
            <div class="chart-container">
                <canvas id="chartAnalistas"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>Distribuição por Cluster</h2>
            <div class="chart-container">
                <canvas id="chartClusters"></canvas>
            </div>
        </div>
    </div>

    <script>
        const analistasFoco = {
            'N0238475': 'MARLEY MARQUES RIBEIRO',
            'N5923221': 'KELLY PINHEIRO LIRA',
            'F160641': 'JENNIFER MARIA ANDRADE SANTOS',
            'N5772086': 'THIAGO PEREIRA DA SILVA',
            'N0239871': 'LEONARDO FERREIRA LIMA DE ALMEIDA',
            'N5577565': 'MARISTELLA MARCIA DOS SANTOS',
            'N5737414': 'SANDRO DA SILVA CARVALHO',
            'N5972428': 'CRISTIANE HERMOGENES DA SILVA',
            'N6173055': 'JEFFERSON LUIS GONÇALVES COITINHO',
            'N5932090': 'EVILÁZIO ANDRÉ DE MAGALHÃES GOMES PEREIRA',
            'N0255801': 'ELBERTON ANICETO HENRIQUE',
            'N4014011': 'ALAN MARINHO DIAS'
        };

        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];

        document.getElementById('fileInput').addEventListener('change', handleFiles, false);

        function handleFiles(event) {
            const files = event.target.files;
            document.getElementById('fileInfo').textContent = `${files.length} arquivo(s) selecionado(s)`;
            
            const promises = Array.from(files).map(readExcel);
            Promise.all(promises).then(dataArrays => {
                const allData = dataArrays.flat();
                processData(allData);
            });
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    resolve(json);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function parseDate(dateStr) {
            // Handle both date formats: Excel serial date or dd/mm/yyyy hh:mm string
            if (typeof dateStr === 'number') {
                // Excel serial date
                const excelEpoch = new Date(1899, 11, 30);
                const excelDate = new Date(excelEpoch.getTime() + dateStr * 24 * 60 * 60 * 1000);
                return excelDate;
            } else if (typeof dateStr === 'string') {
                // dd/mm/yyyy hh:mm format
                const [datePart, timePart] = dateStr.split(' ');
                const [day, month, year] = datePart.split('/');
                const [hours, minutes] = timePart ? timePart.split(':') : ['00', '00'];
                
                return new Date(
                    parseInt(year),
                    parseInt(month) - 1,
                    parseInt(day),
                    parseInt(hours),
                    parseInt(minutes)
                );
            }
            return new Date(dateStr);
        }

        function processData(data) {
            // Update summary information
            document.getElementById('totalOutages').textContent = data.length;
            
            const volumeMes = {};
            const volumeAnalista = {};
            const volumeCluster = {};
            const volumeTecnologia = {};
            const diasPorMes = {};
            const outagesPorDia = {};
            let firstDate = null;
            let lastDate = null;

            data.forEach(row => {
                const dataHora = parseDate(row['DIA / HORA']);
                if (isNaN(dataHora.getTime())) {
                    console.error('Data inválida:', row['DIA / HORA']);
                    return;
                }
                
                const mes = dataHora.getMonth() + 1;
                const dia = dataHora.getDate();
                const login = (row['LOGIN'] || '').toUpperCase();
                const cluster = row['CLUSTER'] || 'Indefinido';
                const tecnologia = row['TECNOLOGIA'] || 'Indefinida';
                const dateKey = dataHora.toISOString().split('T')[0];

                // Track first and last dates
                if (!firstDate || dataHora < firstDate) firstDate = dataHora;
                if (!lastDate || dataHora > lastDate) lastDate = dataHora;

                volumeMes[mes] = (volumeMes[mes] || 0) + 1;
                volumeAnalista[login] = (volumeAnalista[login] || 0) + 1;
                volumeCluster[cluster] = (volumeCluster[cluster] || 0) + 1;
                volumeTecnologia[tecnologia] = (volumeTecnologia[tecnologia] || 0) + 1;
                outagesPorDia[dateKey] = (outagesPorDia[dateKey] || 0) + 1;

                diasPorMes[mes] = diasPorMes[mes] || {};
                diasPorMes[mes][dia] = (diasPorMes[mes][dia] || 0) + 1;
            });

            // Update analysis period
            if (firstDate && lastDate) {
                const formatOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
                const startStr = firstDate.toLocaleDateString('pt-BR', formatOptions);
                const endStr = lastDate.toLocaleDateString('pt-BR', formatOptions);
                document.getElementById('analysisPeriod').textContent = `${startStr} a ${endStr}`;
                
                // Calculate daily average
                const daysDiff = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24)) + 1;
                const dailyAvg = (data.length / daysDiff).toFixed(1);
                document.getElementById('dailyAverage').textContent = dailyAvg;
            }

            renderList('volumeMes', volumeMes, monthNames);
            renderAnalistas('volumeAnalista', volumeAnalista, analistasFoco);
            renderList('volumeCluster', volumeCluster);
            renderList('volumeTecnologia', volumeTecnologia);
            renderDias('volumeDias', diasPorMes);

            renderAnalystChart(volumeAnalista, analistasFoco);
            renderMonthlyChart(volumeMes);
            renderClusterChart(volumeCluster);
        }

        function renderList(elementId, dataObj, labelsArray = null) {
            const ul = document.getElementById(elementId);
            ul.innerHTML = '';
            
            // Convert object to array and sort by value (descending)
            const sortedEntries = Object.entries(dataObj)
                .sort((a, b) => b[1] - a[1]);
            
            // Get max value for progress bars
            const maxValue = sortedEntries.length > 0 ? sortedEntries[0][1] : 1;
            
            sortedEntries.forEach(([key, value]) => {
                const li = document.createElement('li');
                
                // Use labels array if provided (for months)
                const displayKey = labelsArray && labelsArray[key - 1] ? 
                    `${labelsArray[key - 1]}` : key;
                
                li.innerHTML = `
                    <span>${displayKey}</span>
                    <span class="value">${value}</span>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${(value / maxValue) * 100}%"></div>
                    </div>
                `;
                ul.appendChild(li);
            });
        }

        function renderAnalistas(elementId, dataObj, focus) {
            const ul = document.getElementById(elementId);
            ul.innerHTML = '';
            let outros = 0;

            // Calculate total for focus analysts
            const focusEntries = Object.entries(focus).map(([login, nome]) => {
                return { login, nome, count: dataObj[login] || 0 };
            });

            // Sort focus analysts by count (descending)
            focusEntries.sort((a, b) => b.count - a.count);

            // Calculate max value for progress bars
            const maxValue = focusEntries.length > 0 ? 
                Math.max(...focusEntries.map(e => e.count), 0) : 1;

            // Add focus analysts
            focusEntries.forEach(({ nome, count }) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${nome}</span>
                    <span class="value">${count}</span>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${(count / maxValue) * 100}%"></div>
                    </div>
                `;
                ul.appendChild(li);
            });

            // Calculate "outros"
            Object.keys(dataObj).forEach(login => {
                if (!focus[login]) {
                    outros += dataObj[login];
                }
            });

            if (outros > 0) {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>OUTROS</span>
                    <span class="value">${outros}</span>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${(outros / maxValue) * 100}%"></div>
                    </div>
                `;
                ul.appendChild(li);
            }
        }

        function renderDias(elementId, diasPorMes) {
            const ul = document.getElementById(elementId);
            ul.innerHTML = '';
            
            Object.keys(diasPorMes).sort().forEach(mes => {
                const dias = diasPorMes[mes];
                const sorted = Object.entries(dias).sort((a,b) => b[1]-a[1]);
                const maior = sorted[0];
                const menor = sorted[sorted.length -1];
                
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="month-name">${monthNames[mes-1]}</span>
                    <span>
                        <strong>Maior:</strong> dia ${maior[0]} (${maior[1]}) | 
                        <strong>Menor:</strong> dia ${menor[0]} (${menor[1]})
                    </span>
                `;
                ul.appendChild(li);
            });
        }

        function renderAnalystChart(analistas, focus) {
            const ctx = document.getElementById('chartAnalistas').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.analystChart) {
                window.analystChart.destroy();
            }

            const focusAnalistas = Object.keys(focus);
            const labels = focusAnalistas.map(login => focus[login]).concat(['OUTROS']);

            const data = focusAnalistas.map(login => analistas[login] || 0);
            const outros = Object.keys(analistas).reduce((sum, login) => {
                return focusAnalistas.includes(login) ? sum : sum + analistas[login];
            }, 0);
            data.push(outros);

            window.analystChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume por Analista',
                        data: data,
                        backgroundColor: '#E60012',
                        borderColor: '#C5000F',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} outages`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Outages'
                            }
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderMonthlyChart(volumeMes) {
            const ctx = document.getElementById('chartMonthly').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.monthlyChart) {
                window.monthlyChart.destroy();
            }

            // Prepare data sorted by month
            const sortedMonths = Object.keys(volumeMes)
                .sort((a, b) => a - b)
                .map(month => ({
                    month: parseInt(month),
                    name: monthNames[parseInt(month)-1],
                    count: volumeMes[month]
                }));

            window.monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => m.name),
                    datasets: [{
                        label: 'Outages por Mês',
                        data: sortedMonths.map(m => m.count),
                        backgroundColor: 'rgba(230, 0, 18, 0.2)',
                        borderColor: '#E60012',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} outages`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Outages'
                            }
                        }
                    }
                }
            });
        }

        function renderClusterChart(volumeCluster) {
            const ctx = document.getElementById('chartClusters').getContext('2d');
            
            // Destroy previous chart if it exists
            if (window.clusterChart) {
                window.clusterChart.destroy();
            }

            // Prepare data sorted by count (descending)
            const sortedClusters = Object.entries(volumeCluster)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Show top 10 clusters

            window.clusterChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedClusters.map(c => c[0]),
                    datasets: [{
                        label: 'Outages por Cluster',
                        data: sortedClusters.map(c => c[1]),
                        backgroundColor: '#E60012',
                        borderColor: '#C5000F',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} outages`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Outages'
                            }
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
