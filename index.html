<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Volumetria</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f8f9fa; }
    h2 { color: #343a40; }
    .charts { display: flex; flex-wrap: wrap; gap: 30px; }
    canvas { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 0 8px #ccc; }
    input[type="file"] { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #dee2e6; }
  </style>
</head>
<body>
  <h2>Dashboard de Volumetria</h2>
  <input type="file" id="fileInput" multiple accept=".xlsx" />

  <div class="charts">
    <canvas id="chartAnalistas" width="400" height="300"></canvas>
    <canvas id="chartClusters" width="400" height="300"></canvas>
    <canvas id="chartHorarios" width="400" height="300"></canvas>
    <canvas id="chartDias" width="400" height="300"></canvas>
  </div>

  <div id="tabela"></div>

  <script>
    const loginToName = {
      "n0238475": "MARLEY MARQUES RIBEIRO",
      "n5923221": "KELLY PINHEIRO LIRA",
      "f160641": "JENNIFER MARIA ANDRADE SANTOS",
      "n5772086": "THIAGO PEREIRA DA SILVA",
      "n0239871": "LEONARDO FERREIRA LIMA DE ALMEIDA",
      "n5577565": "MARISTELLA MARCIA DOS SANTOS",
      "n5737414": "SANDRO DA SILVA CARVALHO",
      "n5972428": "CRISTIANE HERMOGENES DA SILVA",
      "n6173055": "JEFFERSON LUIS GONÇALVES COITINHO",
      "n5932090": "EVILÁZIO ANDRÉ DE MAGALHÃES GOMES PEREIRA",
      "n0255801": "ELBERTON ANICETO HENRIQUE",
      "n4014011": "ALAN MARINHO DIAS",
      "n5923996": "JULIO CESAR SANTOS SOARES"
    };

    const charts = {};

    function drawChart(id, labels, data, label, type = 'bar') {
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type: type,
        data: {
          labels,
          datasets: [{
            label,
            data,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    document.getElementById('fileInput').addEventListener('change', async function (e) {
      const files = e.target.files;
      const volumesAnalista = {};
      const volumesCluster = {};
      const volumesHorario = {};
      const volumesDia = [];

      const volumesPorDia = {};
      const output = [];

      for (let file of files) {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });

        workbook.SheetNames.forEach(sheetName => {
          const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

          sheet.forEach(row => {
            const login = String(row['LOGIN'] || '').toLowerCase().trim();
            const volume = Number(row['VOLUME'] || 0);
            const cluster = String(row['CLUSTER'] || 'Indefinido').toUpperCase();
            const hora = String(row['HORA'] || '00:00').slice(0, 2) + 'h';
            const data = String(row['DATA'] || '').split('T')[0];

            if (!login) return;

            // Analista
            if (!volumesAnalista[login]) volumesAnalista[login] = 0;
            volumesAnalista[login] += volume;

            // Cluster
            if (!volumesCluster[cluster]) volumesCluster[cluster] = 0;
            volumesCluster[cluster] += volume;

            // Horário
            if (!volumesHorario[hora]) volumesHorario[hora] = 0;
            volumesHorario[hora] += volume;

            // Data (dia)
            if (!volumesPorDia[data]) volumesPorDia[data] = 0;
            volumesPorDia[data] += volume;
          });
        });
      }

      // Tabela resumo
      let tabelaHtml = '<h3>Resumo por Analista</h3><table><tr><th>Login</th><th>Nome</th><th>Total</th></tr>';
      Object.entries(volumesAnalista).sort((a, b) => b[1] - a[1]).forEach(([login, total]) => {
        const nome = loginToName[login] || 'NOME DESCONHECIDO';
        tabelaHtml += `<tr><td>${login.toUpperCase()}</td><td>${nome}</td><td>${total}</td></tr>`;
      });
      tabelaHtml += '</table>';
      document.getElementById('tabela').innerHTML = tabelaHtml;

      // Gráficos
      drawChart('chartAnalistas',
        Object.keys(volumesAnalista).map(k => loginToName[k] || k.toUpperCase()),
        Object.values(volumesAnalista),
        'Volume por Analista'
      );
      drawChart('chartClusters',
        Object.keys(volumesCluster),
        Object.values(volumesCluster),
        'Volume por Cluster'
      );
      drawChart('chartHorarios',
        Object.keys(volumesHorario),
        Object.values(volumesHorario),
        'Volume por Horário'
      );
      drawChart('chartDias',
        Object.keys(volumesPorDia),
        Object.values(volumesPorDia),
        'Volume por Dia',
        'line'
      );
    });
  </script>
</body>
</html>
