<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Análise de Tickets</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #333;
        }
        .upload-container {
            margin-bottom: 20px;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            text-align: center;
        }
        .results {
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .highlight {
            background-color: #f8f8f8;
            font-weight: bold;
        }
        .turno-table {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <h1>Painel de Análise de Tickets</h1>
    
    <div class="upload-container">
        <h2>Upload do Arquivo</h2>
        <input type="file" id="fileInput" accept=".xlsx, .xls" />
        <button onclick="processFile()">Processar Arquivo</button>
    </div>
    
    <div class="results" id="results" style="display: none;">
        <h2>Resultados</h2>
        
        <h3>Resumo Geral</h3>
        <table>
            <tr>
                <th>Métrica</th>
                <th>Valor</th>
            </tr>
            <tr>
                <td>Total de tickets</td>
                <td id="totalTickets">-</td>
            </tr>
            <tr>
                <td>Total de tickets perdidos</td>
                <td id="totalPerdidos">-</td>
            </tr>
            <tr>
                <td>Total de tickets perdidos com menos de 30 min</td>
                <td id="perdidosMenos30">-</td>
            </tr>
            <tr class="highlight">
                <td>% de tickets perdidos com menos de 30 min (sobre total perdidos)</td>
                <td id="percentMenos30">-</td>
            </tr>
        </table>
        
        <h3>Análise por Turno</h3>
        <table class="turno-table" id="turnoTable">
            <tr>
                <th>Turno</th>
                <th>Total Tickets</th>
                <th>Tickets Perdidos</th>
                <th>Perdidos <30 min</th>
                <th>% Perdidos <30 min</th>
            </tr>
            <!-- Os dados serão inseridos aqui pelo JavaScript -->
        </table>
    </div>

    <script>
        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo primeiro.');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Supondo que os dados estão na primeira planilha
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Converter para JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // Processar os dados
                analyzeData(jsonData);
                
                // Mostrar os resultados
                document.getElementById('results').style.display = 'block';
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function analyzeData(data) {
            // Inicializar contadores
            let totalTickets = 0;
            let totalPerdidos = 0;
            let perdidosMenos30 = 0;
            
            // Contadores por turno
            const turnos = {
                MADRUGADA: { total: 0, perdidos: 0, perdidosMenos30: 0 },
                MANHÃ: { total: 0, perdidos: 0, perdidosMenos30: 0 },
                TARDE: { total: 0, perdidos: 0, perdidosMenos30: 0 }
            };
            
            // Processar cada linha
            data.forEach(row => {
                if (!row.Turno) return; // Ignorar linhas sem turno
                
                totalTickets++;
                
                // Verificar se é um ticket perdido (Indicador = 0)
                const isPerdido = row.Indicador === 0;
                
                // Calcular duração (assumindo que a coluna Tempo está no formato HH:MM:SS)
                let duracaoMinutos = 0;
                if (row.Tempo) {
                    if (typeof row.Tempo === 'string') {
                        // Se for string, assumir formato "HH:MM:SS"
                        const [hours, minutes, seconds] = row.Tempo.split(':').map(Number);
                        duracaoMinutos = hours * 60 + minutes + seconds / 60;
                    } else if (typeof row.Tempo === 'number') {
                        // Se for número, assumir que é fração de dia (formato Excel)
                        duracaoMinutos = row.Tempo * 24 * 60;
                    }
                }
                
                // Atualizar contadores gerais
                if (isPerdido) {
                    totalPerdidos++;
                    if (duracaoMinutos < 30) {
                        perdidosMenos30++;
                    }
                }
                
                // Atualizar contadores por turno
                const turno = row.Turno.toUpperCase();
                if (turnos[turno]) {
                    turnos[turno].total++;
                    
                    if (isPerdido) {
                        turnos[turno].perdidos++;
                        
                        if (duracaoMinutos < 30) {
                            turnos[turno].perdidosMenos30++;
                        }
                    }
                }
            });
            
            // Atualizar a interface
            document.getElementById('totalTickets').textContent = totalTickets;
            document.getElementById('totalPerdidos').textContent = totalPerdidos;
            document.getElementById('perdidosMenos30').textContent = perdidosMenos30;
            
            const percentMenos30 = totalPerdidos > 0 ? 
                ((perdidosMenos30 / totalPerdidos) * 100).toFixed(2) + '%' : '0%';
            document.getElementById('percentMenos30').textContent = percentMenos30;
            
            // Preencher tabela de turnos
            const turnoTable = document.getElementById('turnoTable');
            
            // Limpar linhas existentes (exceto cabeçalho)
            while (turnoTable.rows.length > 1) {
                turnoTable.deleteRow(1);
            }
            
            // Adicionar dados por turno
            for (const [turno, dados] of Object.entries(turnos)) {
                const row = turnoTable.insertRow();
                
                const percentPerdidos = dados.total > 0 ? 
                    ((dados.perdidos / dados.total) * 100).toFixed(2) + '%' : '0%';
                
                const percentMenos30Turno = dados.perdidos > 0 ? 
                    ((dados.perdidosMenos30 / dados.perdidos) * 100).toFixed(2) + '%' : '0%';
                
                row.insertCell(0).textContent = turno;
                row.insertCell(1).textContent = dados.total;
                row.insertCell(2).textContent = dados.perdidos;
                row.insertCell(3).textContent = dados.perdidosMenos30;
                row.insertCell(4).textContent = percentMenos30Turno;
            }
        }
    </script>
</body>
</html>
