<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Análise de Tickets - Claro Brasil</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #E31937;
            --secondary-color: #C0102C;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #FFA500;
            --light-color: #F8F8F8;
            --dark-color: #333333;
            --text-color: #333333;
            --border-color: #DDDDDD;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #FFFFFF;
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px 0;
            margin-bottom: 30px;
        }

        header h1 {
            color: white;
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        /* Restante do CSS mantido igual ao anterior */
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Painel de Análise de Tickets - Claro Brasil</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="upload-container card">
            <h2>Upload do Arquivo</h2>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls" />
            <label for="fileInput" class="file-label">Selecionar Arquivo</label>
            <button id="processBtn" class="btn btn-upload">Processar Arquivo</button>
            <div id="fileName" style="margin-top: 10px; font-size: 14px;"></div>
            <div id="loadingIndicator" style="display: none; margin-top: 15px;">
                <div class="loading-container">
                    <div style="margin-right: 10px;">Processando dados...</div>
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <div class="results" id="results" style="display: none;">
            <!-- Conteúdo mantido igual -->
        </div>
    </div>

    <script>
        // Código JavaScript completo corrigido
        let processedData = {
            ticketsForaSLA: [],
            turnos: {
                MANHÃ: { tickets: [], total: 0, dentro: 0, fora: 0, foraMenos30: 0 },
                TARDE: { tickets: [], total: 0, dentro: 0, fora: 0, foraMenos30: 0 },
                MADRUGADA: { tickets: [], total: 0, dentro: 0, fora: 0, foraMenos30: 0 }
            },
            summary: {
                totalTickets: 0,
                totalDentroSLA: 0,
                totalForaSLA: 0,
                foraSlaMenos30: 0
            },
            rawData: []
        };

        let turnoChart, slaChart;

        document.addEventListener('DOMContentLoaded', function() {
            const lastProcess = localStorage.getItem('lastProcess');
            if(lastProcess) {
                try {
                    processedData = JSON.parse(lastProcess);
                    updateAllViews();
                    document.getElementById('results').style.display = 'block';
                } catch (e) {
                    console.error('Erro ao carregar último processamento:', e);
                    localStorage.removeItem('lastProcess');
                }
            }

            document.getElementById('processBtn').addEventListener('click', processFile);
            document.getElementById('fileInput').addEventListener('change', function(e) {
                document.getElementById('fileName').textContent = e.target.files[0]?.name || 'Nenhum arquivo selecionado';
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(this.dataset.tab).classList.add('active');
                    if(this.dataset.tab === 'graficos') updateCharts();
                });
            });
        });

        function processFile() {
            const file = document.getElementById('fileInput').files[0];
            if(!file) {
                showNotification('Selecione um arquivo primeiro!', 'error');
                return;
            }

            const loadingIndicator = document.getElementById('loadingIndicator');
            const processBtn = document.getElementById('processBtn');
            
            loadingIndicator.style.display = 'flex';
            processBtn.disabled = true;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    processedData.rawData = jsonData;
                    analyzeData(jsonData);
                    
                    document.getElementById('results').style.display = 'block';
                    showNotification('Arquivo processado com sucesso!', 'success');
                    
                } catch (error) {
                    showNotification(`Erro: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    loadingIndicator.style.display = 'none';
                    processBtn.disabled = false;
                }
            };

            reader.onerror = () => {
                showNotification('Erro na leitura do arquivo', 'error');
                loadingIndicator.style.display = 'none';
                processBtn.disabled = false;
            };

            reader.readAsArrayBuffer(file);
        }

        function analyzeData(data) {
            try {
                // Resetar dados
                processedData = {
                    ticketsForaSLA: [],
                    turnos: {
                        MANHÃ: { tickets: [], total: 0, dentro: 0, fora: 0, foraMenos30: 0 },
                        TARDE: { tickets: [], total: 0, dentro: 0, fora: 0, foraMenos30: 0 },
                        MADRUGADA: { tickets: [], total: 0, dentro: 0, fora: 0, foraMenos30: 0 }
                    },
                    summary: {
                        totalTickets: 0,
                        totalDentroSLA: 0,
                        totalForaSLA: 0,
                        foraSlaMenos30: 0
                    },
                    rawData: data
                };

                data.forEach((row, index) => {
                    try {
                        validateData(row);
                        if(row.Volume !== 1) return;

                        const turno = row.Turno.toUpperCase();
                        if(!processedData.turnos[turno]) return;

                        processedData.summary.totalTickets++;
                        processedData.turnos[turno].total++;

                        const duracaoMinutos = parseDuration(row.Tempo);
                        const ticketInfo = {
                            id: row.Outage || "N/A",
                            login: row.Login || "N/A",
                            duracaoMinutos: duracaoMinutos,
                            turno: turno
                        };

                        if(row.Indicador === 1) {
                            processedData.summary.totalDentroSLA++;
                            processedData.turnos[turno].dentro++;
                        } else if(row.Indicador === 0) {
                            processedData.summary.totalForaSLA++;
                            processedData.ticketsForaSLA.push(ticketInfo);
                            processedData.turnos[turno].fora++;

                            if(duracaoMinutos < 30) {
                                processedData.summary.foraSlaMenos30++;
                                processedData.turnos[turno].foraMenos30++;
                                processedData.turnos[turno].tickets.push(ticketInfo);
                            }
                        }

                    } catch (error) {
                        throw new Error(`Linha ${index + 2}: ${error.message}`);
                    }
                });

                localStorage.setItem('lastProcess', JSON.stringify(processedData));
                updateAllViews();

            } catch (error) {
                showNotification(error.message, 'error');
                throw error;
            }
        }

        function validateData(row) {
            const requiredColumns = ['Turno', 'Volume', 'Indicador', 'Tempo'];
            const missing = requiredColumns.filter(col => !(col in row));
            if(missing.length > 0) throw new Error(`Colunas faltantes: ${missing.join(', ')}`);

            if(typeof row.Indicador !== 'number' || ![0, 1].includes(row.Indicador)) {
                throw new Error('Indicador deve ser 0 ou 1');
            }

            if(typeof row.Volume !== 'number' || row.Volume < 0) {
                throw new Error('Volume inválido');
            }
        }

        function parseDuration(time) {
            try {
                if(typeof time === 'number') return Math.round(time * 24 * 60 * 100) / 100;
                if(typeof time === 'string') {
                    if(time.includes('.')) return parseFloat(time) * 60;
                    const [h, m, s] = time.split(':').map(Number);
                    return h * 60 + m + (s || 0)/60;
                }
                throw new Error('Formato de tempo desconhecido');
            } catch (e) {
                throw new Error(`Tempo inválido: ${time}`);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Funções de atualização de visualização mantidas conforme anterior
    </script>
</body>
</html>
