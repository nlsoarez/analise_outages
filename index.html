<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Outages</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        canvas { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Dashboard de Outages</h1>
    <input type="file" id="fileInput" multiple>
    
    <h2>Volume por Mês</h2>
    <ul id="volumeMes"></ul>

    <h2>Volume por Analista</h2>
    <ul id="volumeAnalista"></ul>

    <h2>Volume por Cluster</h2>
    <ul id="volumeCluster"></ul>

    <canvas id="chartAnalistas"></canvas>

    <script>
        const analistasFoco = {
            'N0238475': 'MARLEY MARQUES RIBEIRO',
            'N5923221': 'KELLY PINHEIRO LIRA',
            'F160641': 'JENNIFER MARIA ANDRADE SANTOS',
            'N5772086': 'THIAGO PEREIRA DA SILVA',
            'N0239871': 'LEONARDO FERREIRA LIMA DE ALMEIDA',
            'N5577565': 'MARISTELLA MARCIA DOS SANTOS',
            'N5737414': 'SANDRO DA SILVA CARVALHO',
            'N5972428': 'CRISTIANE HERMOGENES DA SILVA',
            'N6173055': 'JEFFERSON LUIS GONÇALVES COITINHO',
            'N5932090': 'EVILÁZIO ANDRÉ DE MAGALHÃES GOMES PEREIRA',
            'N0255801': 'ELBERTON ANICETO HENRIQUE',
            'N4014011': 'ALAN MARINHO DIAS'
        };

        document.getElementById('fileInput').addEventListener('change', handleFiles, false);

        function handleFiles(event) {
            const files = event.target.files;
            const promises = [];

            for (let i = 0; i < files.length; i++) {
                promises.push(readExcel(files[i]));
            }

            Promise.all(promises).then(dataArrays => {
                const allData = dataArrays.flat();
                processData(allData);
            });
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    resolve(json);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function processData(data) {
            const volumeMes = {};
            const volumeAnalista = {};
            const volumeCluster = {};

            data.forEach(row => {
                const dataHora = new Date(row['DIA / HORA']);
                const mes = dataHora.getMonth() + 1; // Janeiro = 1
                const login = (row['LOGIN'] || '').toUpperCase();
                const cluster = row['CLUSTER'] || 'Indefinido';

                // Volume por mês
                volumeMes[mes] = (volumeMes[mes] || 0) + 1;

                // Volume por analista
                volumeAnalista[login] = (volumeAnalista[login] || 0) + 1;

                // Volume por cluster
                volumeCluster[cluster] = (volumeCluster[cluster] || 0) + 1;
            });

            renderList('volumeMes', volumeMes, 'Mês ');
            renderList('volumeAnalista', volumeAnalista, '', analistasFoco);
            renderList('volumeCluster', volumeCluster);

            renderChart(volumeAnalista, analistasFoco);
        }

        function renderList(elementId, dataObj, prefix = '', focus = null) {
            const ul = document.getElementById(elementId);
            ul.innerHTML = '';
            Object.keys(dataObj).sort().forEach(key => {
                let label = key;
                if (focus && focus[key]) {
                    label += ` - ${focus[key]}`;
                }
                const li = document.createElement('li');
                li.textContent = `${prefix}${label}: ${dataObj[key]}`;
                ul.appendChild(li);
            });
        }

        function renderChart(analistas, focus) {
            const ctx = document.getElementById('chartAnalistas').getContext('2d');
            const focusAnalistas = Object.keys(focus);
            const labels = focusAnalistas.concat(['OUTROS']);

            const data = focusAnalistas.map(login => analistas[login] || 0);
            const outros = Object.keys(analistas).reduce((sum, login) => {
                return focusAnalistas.includes(login) ? sum : sum + analistas[login];
            }, 0);
            data.push(outros);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume por Analista',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    </script>
</body>
</html>
